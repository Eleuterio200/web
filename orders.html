<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasteler√≠a Dulce Sabor - Mis Pedidos</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500&display=swap');

        :root {
            --primary: #ec4899;
            --primary-dark: #db2777;
            --secondary: #9f1239;
            --light: #fff1f2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        header {
            background-color: #fecaca;
            padding: 12px 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-placeholder {
            background-color: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            color: var(--secondary);
            margin-left: 12px;
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 32px;
        }

        nav a,
        nav button {
            color: var(--secondary);
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        nav a:hover,
        nav button:hover {
            color: var(--primary);
        }

        .orders-section {
            padding: 48px 24px;
            flex-grow: 1;
        }

        .orders-table {
            max-width: 1280px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f1f1;
        }

        th {
            background: #fecaca;
            color: var(--secondary);
            font-weight: 500;
            font-size: 15px;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        td ul {
            margin: 0;
            padding: 0 0 0 24px;
            font-size: 14px;
        }

        .btn-cancel {
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .btn-cancel:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-proof,
        .btn-ticket,
        .btn-upload {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 2px 0;
        }

        .btn-upload {
            background: var(--warning);
        }

        .btn-upload:hover {
            background: #d97706;
        }

        .btn-proof:hover,
        .btn-ticket:hover {
            background: var(--primary-dark);
        }

        .alert {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            padding: 16px;
            border-radius: 8px;
            margin: 0 auto 24px;
            max-width: 1280px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert-success {
            background-color: #d1fae5;
            border: 1px solid var(--success);
            color: #065f46;
        }

        .alert-error {
            background-color: #fee2e2;
            border: 1px solid var(--danger);
            color: #991b1b;
        }

        .hidden {
            display: none;
        }

        /* MODAL COMPROBANTE */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #fecaca;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--secondary);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 19px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--secondary);
            font-weight: bold;
        }

        .modal-body {
            padding: 20px;
            text-align: center;
            background: #fff;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 65vh;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border: 1px solid #eee;
        }

        .transfer-info {
            background: #fff8e1;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid #fbbf24;
            line-height: 1.6;
        }

        /* MODAL SUBIR COMPROBANTE */
        #uploadModal .modal-content {
            max-width: 500px;
            text-align: center;
            padding: 30px;
        }

        #uploadModal input[type="file"] {
            padding: 15px;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            width: 100%;
            margin: 15px 0;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }

        .btn-cancel-modal {
            background: #ccc;
            color: #333;
        }

        .btn-upload-modal {
            background: var(--primary);
            color: white;
        }

        /* TICKET LIMPIO */
        .ticket-modal .modal-content {
            max-width: 500px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        .ticket-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .ticket-logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-weight: bold;
            font-size: 24px;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .ticket-header h3 {
            margin: 0;
            font-size: 22px;
        }

        .ticket-header p {
            margin: 4px 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .ticket-body {
            padding: 24px;
            font-size: 14px;
            line-height: 1.7;
            color: #333;
        }

        .ticket-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .ticket-info strong {
            color: var(--secondary);
        }

        .ticket-items {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .ticket-items th {
            background: #fdf2f8;
            color: var(--secondary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .ticket-items td {
            padding: 10px;
            border-bottom: 1px dashed #ddd;
            font-size: 13px;
        }

        .dedicatoria {
            font-style: italic;
            color: #d9468f;
            padding-left: 20px;
            font-size: 12px;
            margin: 4px 0;
        }

        .ticket-total {
            font-weight: bold;
            font-size: 17px;
            color: var(--primary);
            text-align: right;
            margin: 16px 0;
        }

        .payment-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin: 8px 0;
        }

        .payment-info strong {
            color: var(--secondary);
        }

        .ticket-note {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin: 20px 0 10px;
            font-weight: 500;
        }

        .ticket-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 24px 24px;
        }

        .btn-print,
        .btn-download {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-print {
            background: var(--success);
            color: white;
        }

        .btn-print:hover {
            background: #059669;
        }

        .btn-download {
            background: var(--primary);
            color: white;
        }

        .btn-download:hover {
            background: var(--primary-dark);
        }

        footer {
            background-color: var(--secondary);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: auto;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .orders-table {
                width: 100%;
                box-shadow: none;
            }

            table {
                display: block;
            }

            thead {
                display: none;
            }

            tr {
                display: block;
                margin-bottom: 16px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            td {
                display: block;
                padding: 12px 16px;
                text-align: left;
                border: none;
                position: relative;
                font-size: 14px;
            }

            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--secondary);
                display: block;
                margin-bottom: 8px;
            }

            td[data-label="Productos"] ul {
                padding-left: 16px;
            }

            td[data-label="Acciones"],
            td[data-label="Comprobante"],
            td[data-label="Ticket"] {
                text-align: center;
            }

            .btn-cancel,
            .btn-proof,
            .btn-ticket,
            .btn-upload {
                width: 100%;
                padding: 10px;
                margin: 4px 0;
                font-size: 14px;
            }

            h1 {
                font-size: 24px;
            }

            .logo-placeholder {
                font-size: 14px;
                height: 36px;
            }

            nav ul {
                gap: 16px;
            }

            nav a,
            nav button {
                font-size: 14px;
            }

            .modal-content,
            .ticket-modal .modal-content {
                max-width: 95%;
            }

            .ticket-info {
                grid-template-columns: 1fr;
            }

            .ticket-buttons {
                flex-direction: column;
                margin: 20px 16px 16px;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #ticketModal,
            #ticketModal * {
                visibility: visible;
            }

            #ticketModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .btn-print,
            .btn-download,
            .modal-close {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo-container">
                <div class="logo-placeholder">Logo</div>
                <h1>Pasteler√≠a Dulce Sabor</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="catalog.html">Cat√°logo</a></li>
                    <li><a href="orders.html">Mis Pedidos</a></li>
                    <li><a href="favorites.html">Favoritos</a></li>
                    <li id="adminLink" class="hidden"><a href="admin.html">Admin</a></li>
                    <li id="authLink"><a href="auth.html">Registro/Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Orders Section -->
    <section class="orders-section">
        <div class="container">
            <h2 style="font-size: 32px; color: #9f1239; text-align: center; margin-bottom: 32px;">Mis Pedidos</h2>
            <div id="alert" class="alert alert-error hidden"></div>
            <div class="orders-table">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Datos Transferencia</th>
                            <th>Comprobante</th>
                            <th>Ticket</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- MODAL VER COMPROBANTE -->
    <div class="modal" id="proofModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Comprobante de Pago</h3>
                <button class="modal-close" id="proofModalClose">X</button>
            </div>
            <div class="modal-body">
                <img id="proofImage" src="" alt="Comprobante de pago">
            </div>
        </div>
    </div>

    <!-- MODAL SUBIR COMPROBANTE -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Subir Comprobante de Pago</h3>
                <button class="modal-close" onclick="document.getElementById('uploadModal').classList.remove('open')">X</button>
            </div>
            <div class="modal-body">
                <p><strong>50% del total: <span id="amountToPay">$0.00</span></strong></p>
                <input type="file" id="proofFile" accept="image/*">
                <div class="upload-buttons">
                    <button class="btn-modal btn-cancel-modal" onclick="document.getElementById('uploadModal').classList.remove('open')">Cancelar</button>
                    <button class="btn-modal btn-upload-modal" onclick="uploadProof()">Subir Comprobante</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TICKET -->
    <div class="modal ticket-modal" id="ticketModal">
        <div class="modal-content">
            <div class="ticket-header">
                <div class="ticket-logo">DS</div>
                <h3>Pasteler√≠a Dulce Sabor</h3>
                <p>Tu dulce momento</p>
            </div>
            <div class="ticket-body" id="ticketBody"></div>
            <p class="ticket-note">50% por transferencia | 50% en efectivo al retirar</p>
            <div class="ticket-buttons">
                <button class="btn-print" onclick="printTicket()">Imprimir</button>
                <button class="btn-download" onclick="downloadTicket()">Descargar PDF</button>
            </div>
            <button class="modal-close" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:22px; color:white; cursor:pointer;" onclick="closeTicket()">X</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>¬© 2025 Pasteler√≠a Dulce Sabor. Todos los derechos reservados.</p>
    </footer>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCcP-o0ptLQM5vOOB0O0Z8hZH_KFv3Uvm8",
        authDomain: "pasteleria-e3386.firebaseapp.com",
        projectId: "pasteleria-e3386",
        storageBucket: "pasteleria-e3386.firebasestorage.app",
        messagingSenderId: "365968659983",
        appId: "1:365968659983:web:2d904933f8f7a91094f57a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authLink = document.getElementById('authLink');
    const adminLink = document.getElementById('adminLink');
    const ordersTableBody = document.getElementById('ordersTableBody');
    const alert = document.getElementById('alert');
    const proofModal = document.getElementById('proofModal');
    const proofImage = document.getElementById('proofImage');
    const proofModalClose = document.getElementById('proofModalClose');
    const ticketModal = document.getElementById('ticketModal');
    const ticketBody = document.getElementById('ticketBody');
    let currentOrderId = null;

    // ICONOS BONITOS DENTRO DE LOS C√çRCULOS
    function generateProgressBar(step) {
        const steps = [
            { num: 1, label: "Pendiente", icon: "‚è≥" },
            { num: 2, label: "Confirmado", icon: "‚úì" },
            { num: 3, label: "En preparaci√≥n", icon: "üë©‚Äçüç≥" },
            { num: 4, label: "Listo", icon: "üéÇ" }
        ];

        let html = `<div style="margin:16px 0; padding:18px 14px; background:#fdf2f8; border-radius:16px; border-left:6px solid #f472b6; position:relative;">`;
        html += `<div style="display:flex; flex-direction:column; gap:22px; position:relative;">`;

        steps.forEach((s, i) => {
            const isActive = step >= s.num;
            const isCurrent = step === s.num;

            // Color verde para pasos completados o actuales (excepto pendiente)
            const bgColor = isActive 
                ? (isCurrent && s.num === 1 ? '#ec4899' : '#10b981') 
                : '#e5e7eb';

            const shadowColor = isCurrent && s.num > 1 
                ? '0 0 0 6px rgba(16,185,129,0.35)' 
                : (isCurrent ? '0 0 0 6px rgba(236,72,153,0.35)' : '0 4px 12px rgba(0,0,0,0.15)');

            html += `
                <div style="display:flex; align-items:center; gap:16px; position:relative; z-index:2;">
                    <div style="
                        width:52px; height:52px; border-radius:50%; flex-shrink:0;
                        background:${bgColor};
                        color:white; display:flex; align-items:center; justify-content:center;
                        font-size:26px;
                        box-shadow:${shadowColor};
                        transition:all 0.3s;
                    ">
                        ${s.icon}
                    </div>
                    <div style="font-size:14.5px; color:${isActive ? '#1f2937' : '#9ca3af'}; font-weight:${isCurrent ? '700' : '500'};">
                        ${i === 0 ? 'Pendiente' : i === 1 ? 'Confirmado' : i === 2 ? 'En preparaci√≥n' : 'Listo'}
                    </div>
                </div>
            `;

            if (i < steps.length - 1) {
                html += `
                    <div style="
                        position:absolute; left:26px; top:62px; height:50px; width:5px;
                        background:${step > s.num ? '#10b981' : '#e2e8f0'};
                        z-index:1; border-radius:3px;
                    "></div>
                `;
            }
        });

        html += `</div></div>`;
        return html;
    }

    // FUNCI√ìN CLAVE: Controla el progreso y colores
    function getProgressInfo(order) {
        const hasProof = !!order.paymentProofBase64;

        if (order.status === 'cancelled') 
            return { step: 0, text: 'Pedido Cancelado', color: '#ef4444' };

        if (order.status === 'pending')     
            return { step: 1, text: 'Esperando Confirmaci√≥n', color: '#ec4899' };

        // Cliente subi√≥ comprobante ‚Üí sigue en Confirmado (verde), NO pasa autom√°tico a preparaci√≥n
        if (order.status === 'confirmed') {
            return hasProof 
                ? { step: 2, text: 'Comprobante recibido ‚Äì Confirmado', color: '#10b981' }
                : { step: 2, text: 'Confirmado ‚Äì Sube tu Comprobante', color: '#ec4899' };
        }

        if (order.status === 'processing')  
            return { step: 3, text: 'En Preparaci√≥n con Amor', color: '#6b7280' }; // Gris hasta que est√© listo

        if (order.status === 'completed')   
            return { step: 4, text: '¬°Listo para Retiro!', color: '#10b981' }; // Verde final

        return { step: 0, text: 'Estado Desconocido', color: '#6b7280' };
    }

    function showAlert(message, type = 'error') {
        alert.className = `alert alert-${type} hidden`;
        alert.textContent = message;
        alert.classList.remove('hidden');
        setTimeout(() => alert.classList.add('show'), 100);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.classList.add('hidden'), 300);
        }, 5000);
    }

    window.showProof = function(base64) {
        proofImage.src = base64;
        proofModal.classList.add('open');
    };
    proofModalClose.addEventListener('click', () => proofModal.classList.remove('open'));
    proofModal.addEventListener('click', e => { if (e.target === proofModal) proofModal.classList.remove('open'); });

    window.openUploadModal = function(orderId, total) {
        currentOrderId = orderId;
        document.getElementById('amountToPay').textContent = '$' + (total * 0.5).toFixed(2);
        document.getElementById('uploadModal').classList.add('open');
    };

    window.uploadProof = async function() {
        const file = document.getElementById('proofFile').files[0];
        if (!file) return showAlert('Selecciona una imagen del comprobante', 'error');
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                await db.collection('orders').doc(currentOrderId).update({
                    paymentProofBase64: e.target.result
                    // NO cambiamos el status aqu√≠ ‚Üí se queda en 'confirmed'
                });
                showAlert('¬°Comprobante recibido! Tu pedido est√° Confirmado', 'success');
                document.getElementById('uploadModal').classList.remove('open');
                loadOrders(auth.currentUser.uid);
            } catch (err) {
                console.error(err);
                showAlert('Error al subir el comprobante', 'error');
            }
        };
        reader.readAsDataURL(file);
    };

    window.showTicket = async function(orderId) {
        currentOrderId = orderId;
        try {
            const doc = await db.collection('orders').doc(orderId).get();
            if (!doc.exists) return showAlert('Pedido no encontrado', 'error');
            const order = doc.data();
            const date = order.createdAt?.toDate().toLocaleString('es-ES') || 'Sin fecha';
            const paid = order.total * 0.5;
            const remaining = order.total * 0.5;
            let itemsHTML = '';
            order.items.forEach(item => {
                itemsHTML += `<tr><td>${item.name} √ó${item.quantity}</td><td>$${(item.price * item.quantity).toFixed(2)}</td></tr>`;
                if (item.dedicatoria) itemsHTML += `<tr><td colspan="2" class="dedicatoria">‚Äú${item.dedicatoria}‚Äù</td></tr>`;
            });
            ticketBody.innerHTML = `
                <div class="ticket-info">
                    <div><strong>Cliente:</strong> ${order.userEmail}</div>
                    <div><strong>Fecha:</strong> ${date}</div>
                    <div><strong>Entrega:</strong> ${order.scheduledDate}</div>
                    <div><strong>Hora:</strong> ${order.scheduledTime || 'No especificada'}</div>
                </div>
                <table class="ticket-items"><thead><tr><th>Producto</th><th>Precio</th></tr></thead><tbody>${itemsHTML}</tbody></table>
                <div class="ticket-total">Total: $${order.total.toFixed(2)}</div>
                <div class="payment-info">
                    <span><strong>Pagado (50%):</strong> $${paid.toFixed(2)}</span>
                    <span style="color:#ef4444;"><strong>Resta (50%):</strong> $${remaining.toFixed(2)}</span>
                </div>
            `;
            ticketModal.classList.add('open');
        } catch (error) {
            showAlert('Error al cargar el ticket', 'error');
        }
    };

    window.closeTicket = () => ticketModal.classList.remove('open');
    window.printTicket = () => window.print();
    window.downloadTicket = () => {
        if (!currentOrderId) return;
        const element = document.querySelector('#ticketModal .modal-content');
        const opt = { 
            margin: 0.5, 
            filename: `ticket_${currentOrderId}.pdf`, 
            image: { type: 'jpeg', quality: 0.98 }, 
            html2canvas: { scale: 2 }, 
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    };
    ticketModal.addEventListener('click', e => { if (e.target === ticketModal) closeTicket(); });

    async function loadOrders(userId) {
        try {
            const snapshot = await db.collection('orders')
                .where('userId', '==', userId)
                .orderBy('createdAt', 'desc')
                .get();

            ordersTableBody.innerHTML = '';

            if (snapshot.empty) {
                ordersTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:80px;color:#888;font-size:18px;">A√∫n no tienes pedidos<br><br><a href="catalog.html" style="color:#ec4899;text-decoration:underline;">¬°Haz tu primer pedido!</a></td></tr>`;
                return;
            }

            const transferInfo = `
                <div class="transfer-info">
                    <strong>Banco:</strong> BBVA<br>
                    <strong>Cuenta:</strong> 012 345 6789<br>
                    <strong>CLABE:</strong> 0121 8000 1234 5678 90<br>
                    <strong>A nombre de:</strong> Dulce Sabor S.A. de C.V.
                </div>`;

            snapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;

                const itemsList = order.items.map(item => 
                    `<li>${item.name} (x${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}</li>`
                ).join('');

                const date = order.createdAt
                    ? order.createdAt.toDate().toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' })
                    : 'Sin fecha';

                const progress = getProgressInfo(order);
                const hasProof = !!order.paymentProofBase64;

                const comprobanteHTML = hasProof
                    ? `<button class="btn-proof" onclick="showProof('${order.paymentProofBase64}')">Ver Comprobante</button>`
                    : `<button class="btn-upload" onclick="openUploadModal('${doc.id}', ${order.total})">Subir comprobante</button>`;

                const ticketHTML = hasProof
                    ? `<button class="btn-ticket" onclick="showTicket('${doc.id}')">Ver Ticket</button>`
                    : `<em style="color:#aaa;">Esperando comprobante</em>`;

                const row = `
                    <tr>
                        <td data-label="Fecha">${date}</td>
                        <td data-label="Productos"><ul>${itemsList}</ul></td>
                        <td data-label="Total">$${order.total.toFixed(2)}</td>
                        <td data-label="Datos Transferencia">${transferInfo}</td>
                        <td data-label="Comprobante">${comprobanteHTML}</td>
                        <td data-label="Ticket">${ticketHTML}</td>
                        <td data-label="Estado" style="padding:20px 16px; vertical-align:top;">
                            <div style="text-align:center; margin-bottom:18px;">
                                <strong style="color:${progress.color}; font-size:19px; font-weight:700;">${progress.text}</strong>
                            </div>
                            ${generateProgressBar(progress.step)}
                        </td>
                        <td data-label="Acciones" style="text-align:center; vertical-align:middle;">
                            ${order.status === 'pending'
                                ? `<button class="btn-cancel" onclick="cancelOrder('${doc.id}')">Cancelar Pedido</button>`
                                : order.status === 'cancelled'
                                    ? '<em style="color:#ef4444; font-weight:bold;">Cancelado</em>'
                                    : '<em style="color:#6b7280;">No cancelable</em>'
                            }
                        </td>
                    </tr>
                `;
                ordersTableBody.innerHTML += row;
            });
        } catch (error) {
            console.error(error);
            showAlert('Error al cargar pedidos', 'error');
        }
    }

    window.cancelOrder = async function(orderId) {
        if (!confirm('¬øSeguro que deseas cancelar este pedido?')) return;
        try {
            await db.collection('orders').doc(orderId).update({ status: 'cancelled' });
            showAlert('Pedido cancelado correctamente', 'success');
            loadOrders(auth.currentUser.uid);
        } catch (e) {
            showAlert('Error al cancelar el pedido', 'error');
        }
    };

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                authLink.innerHTML = '<button id="signOutNavBtn">Cerrar Sesi√≥n</button>';
                document.getElementById('signOutNavBtn')?.addEventListener('click', () => auth.signOut().then(() => location.href = 'index.html'));
                if (userDoc.data().role === 'admin') adminLink.classList.remove('hidden');
                loadOrders(user.uid);
            }
        } else {
            location.href = 'auth.html';
        }
    });
</script>
</html>